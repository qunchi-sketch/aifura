<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>AIpp Â· Image â‡„ PDF Toolkit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #007aff;
      --bg: #f5f5f7;
      --card-bg: #fff;
      --text: #222;
      --border: #e5e5ea;
    }

    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    body {
      margin: 0; padding: 20px; background: var(--bg); color: var(--text);
      display: flex; justify-content: center; min-height: 100vh;
    }

    .app {
      max-width: 800px; width: 100%; background: var(--card-bg);
      border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden; display: flex; flex-direction: column;
    }

    /* Header */
    .app-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .header-content { flex: 1; }
    .app-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .app-sub { font-size: 13px; color: #666; }
    
    .lang-btn {
      font-size: 12px; font-weight: 600; padding: 4px 10px;
      border: 1px solid var(--border); border-radius: 20px;
      background: #fff; color: #666; cursor: pointer; transition: 0.2s;
      margin-left: 10px;
    }
    .lang-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* Tabs */
    .tabs { display: flex; background: #fafafa; border-bottom: 1px solid var(--border); }
    .tab {
      flex: 1; text-align: center; padding: 14px; cursor: pointer;
      font-size: 14px; font-weight: 500; color: #666;
      border-bottom: 2px solid transparent; transition: 0.2s;
    }
    .tab:hover { background: #f0f0f0; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; font-weight: 600; }

    /* Content */
    .tab-content { padding: 24px; display: none; animation: fadeIn 0.3s ease; flex: 1; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Upload Area */
    .upload-area {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 2px dashed #c7c7cc; border-radius: 12px; padding: 40px 20px;
      background: #fafafa; cursor: pointer; transition: 0.2s; text-align: center;
    }
    .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: #f0f6ff; }
    .upload-area strong { color: var(--primary); }
    input[type="file"] { display: none; }

    /* List & Items */
    .section-title { font-size: 14px; font-weight: 600; margin: 20px 0 10px; color: #333; display: flex; justify-content: space-between; align-items: center; }
    
    .list-container {
      border: 1px solid var(--border); border-radius: 12px;
      max-height: 320px; overflow-y: auto; background: #fff;
    }
    
    .item {
      display: flex; align-items: center; padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0; transition: background 0.2s;
    }
    .item:last-child { border-bottom: none; }
    .item:hover { background: #fafafa; }
    
    .item-thumb {
      width: 40px; height: 40px; border-radius: 6px; background: #eee;
      object-fit: cover; margin-right: 12px; border: 1px solid #eee;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item-meta { font-size: 11px; color: #888; margin-top: 2px; }
    
    .item-actions { display: flex; gap: 6px; }

    /* Buttons */
    .btn {
      border: none; outline: none; background: #e5e5ea; color: #333;
      padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;
      transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover { background: #d1d1d6; }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); color: white; padding: 10px 24px; font-weight: 500; border-radius: 8px; }
    .btn-primary:hover { background: #0063ce; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
    .btn-sm { padding: 4px 8px; font-size: 12px; border-radius: 4px; }
    .btn-danger { color: #ff3b30; background: rgba(255, 59, 48, 0.1); }
    .btn-danger:hover { background: rgba(255, 59, 48, 0.2); }

    /* Footer Controls */
    .footer-controls { margin-top: 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    .status-text { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; }
    .spinner {
      width: 14px; height: 14px; border: 2px solid #ccc; border-top-color: var(--primary);
      border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Config Area */
    .config-panel {
      margin-top: 16px; background: #f9f9fb; border-radius: 12px; padding: 16px; border: 1px solid #eee;
    }
    .config-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .config-row:last-child { margin-bottom: 0; }
    .config-label { font-size: 13px; font-weight: 600; color: #444; min-width: 70px; }
    
    .form-select, .form-input {
      padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; background: #fff;
    }
    .form-select:focus, .form-input:focus { border-color: var(--primary); outline: none; }

    .advanced-options {
      display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;
      animation: slideDown 0.2s ease;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    .page-item-label {
      flex: 1; display: flex; align-items: center; cursor: pointer; user-select: none;
    }
    .page-item-label input { margin-right: 10px; accent-color: var(--primary); }

    /* Copyright Footer */
    .copyright-footer {
      text-align: center; padding: 12px; font-size: 12px; color: #999;
      background: #fafafa; border-top: 1px solid #e5e5ea;
    }
    .copyright-footer a { color: #666; text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .copyright-footer a:hover { color: var(--primary); text-decoration: underline; }
    .copyright-divider { margin: 0 6px; color: #ddd; }

    @media (max-width: 600px) {
      .app { border-radius: 0; height: 100vh; max-width: none; }
      .upload-area { padding: 24px; }
      .config-row { flex-direction: column; align-items: flex-start; gap: 6px; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="app-header">
    <div class="header-content">
      <div class="app-title" data-i18n="title">Image â‡„ PDF å·¥å…·ç®± V3</div>
      <div class="app-sub" data-i18n="subtitle">çº¯å‰ç«¯å¤„ç† Â· å®‰å…¨æ— ä¸Šä¼  Â· å¢å¼ºæ’ç‰ˆ</div>
    </div>
    <button class="lang-btn" onclick="toggleLanguage()" id="btn-lang">EN</button>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('img2pdf')" data-i18n="tab_i2p">å›¾ç‰‡è½¬ PDF</div>
    <div class="tab" onclick="switchTab('pdf2img')" data-i18n="tab_p2i">PDF è½¬å›¾ç‰‡</div>
  </div>

  <div class="tab-content active" id="tab-img2pdf">
    <label class="upload-area" id="drop-area-img">
      <input type="file" id="input-img" accept="image/jpeg, image/png, image/webp" multiple>
      <div><strong data-i18n="click_upload">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</strong> <span data-i18n="or_drag">æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</span></div>
      <div style="font-size:12px; color:#999; margin-top:6px;" data-i18n="img_support">æ”¯æŒ JPG / PNG / WebP</div>
    </label>
    
    <div class="config-panel">
      <div class="config-row">
        <div class="config-label" data-i18n="label_size">é¡µé¢å°ºå¯¸</div>
        <select id="pdf-size-mode" class="form-select" onchange="toggleAdvancedOptions()">
            <option value="auto" data-i18n="opt_auto">åŸå›¾å°ºå¯¸ (æ— ç™½è¾¹/æœ€ä½³æ•ˆæœ)</option>
            <option value="a4" data-i18n="opt_a4">A4 æ ‡å‡†çº¸ (210x297mm)</option>
            <option value="a5" data-i18n="opt_a5">A5 æ ‡å‡†çº¸ (148x210mm)</option>
        </select>
        <span style="font-size:12px; color:#888; flex:1;">
          <span id="hint-auto" data-i18n="hint_auto">ğŸ” æ ¹æ®å›¾ç‰‡å¤§å°è‡ªåŠ¨ç”Ÿæˆ PDFï¼Œé€‚åˆå­˜æ¡£ã€‚</span>
          <span id="hint-standard" style="display:none" data-i18n="hint_std">ğŸ–¨ï¸ é€‚åˆæ‰“å°ï¼Œæ”¯æŒé¡µè¾¹è·è°ƒæ•´ã€‚</span>
        </span>
      </div>

      <div class="advanced-options" id="advanced-options">
        <div class="config-row">
          <div class="config-label" data-i18n="label_margin">é¡µè¾¹è·</div>
          <input type="number" id="pdf-margin" class="form-input" value="10" min="0" max="50" style="width: 70px;">
          <span style="font-size:12px; color:#666;" data-i18n="unit_mm">æ¯«ç±³ (mm)</span>
        </div>
        <div class="config-row">
            <div class="config-label" data-i18n="label_align">å›¾ç‰‡ä½ç½®</div>
            <select id="pdf-align" class="form-select">
                <option value="center" data-i18n="align_center">å‚ç›´å±…ä¸­ (Center)</option>
                <option value="top" data-i18n="align_top">é¡¶éƒ¨å¯¹é½ (Top)</option>
                <option value="bottom" data-i18n="align_bottom">åº•éƒ¨å¯¹é½ (Bottom)</option>
            </select>
        </div>
      </div>
    </div>

    <div class="section-title">
      <span><span data-i18n="sect_selected">å·²é€‰å›¾ç‰‡</span> <small id="img-count" style="color:#888; font-weight:400">(0)</small></span>
      <button class="btn btn-sm btn-danger" onclick="clearImages()" data-i18n="btn_clear">æ¸…ç©ºåˆ—è¡¨</button>
    </div>

    <div class="list-container" id="list-img">
      <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;" data-i18n="empty_img">æš‚æœªæ·»åŠ å›¾ç‰‡</div>
    </div>

    <div class="footer-controls">
      <div class="status-text">
        <div class="spinner" id="spinner-img"></div>
        <span id="status-img" data-i18n="status_ready">å‡†å¤‡å°±ç»ª</span>
      </div>
      <button class="btn btn-primary" id="btn-gen-pdf" onclick="generatePDF()" data-i18n="btn_gen">ç”Ÿæˆå¹¶ä¸‹è½½ PDF</button>
    </div>
  </div>

  <div class="tab-content" id="tab-pdf2img">
    <label class="upload-area" id="drop-area-pdf">
      <input type="file" id="input-pdf" accept="application/pdf">
      <div><strong data-i18n="click_upload_pdf">ç‚¹å‡»ä¸Šä¼  PDF</strong> <span data-i18n="or_drag">æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</span></div>
      <div style="font-size:12px; color:#999; margin-top:6px;" data-i18n="pdf_support">ä»…æ”¯æŒå•ä¸ª PDF æ–‡ä»¶</div>
    </label>

    <div class="section-title">
      <span data-i18n="sect_export">é€‰æ‹©å¯¼å‡ºé¡µé¢</span>
      <div>
        <button class="btn btn-sm" onclick="togglePdfPages(true)" data-i18n="btn_all">å…¨é€‰</button>
        <button class="btn btn-sm" onclick="togglePdfPages(false)" data-i18n="btn_none">å…¨ä¸é€‰</button>
      </div>
    </div>

    <div class="list-container" id="list-pdf-pages">
      <div style="padding: 20px; text-align: center; color: #999; font-size: 13px;" data-i18n="empty_pdf">è¯·å…ˆä¸Šä¼  PDF æ–‡ä»¶</div>
    </div>

    <div class="footer-controls">
      <div class="status-text">
        <div class="spinner" id="spinner-pdf"></div>
        <span id="status-pdf" data-i18n="status_wait_pdf">ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...</span>
      </div>
      <button class="btn btn-primary" id="btn-export-img" onclick="exportImages()" disabled data-i18n="btn_export">å¯¼å‡ºä¸º ZIP</button>
    </div>
  </div>

  <div class="copyright-footer">
    Created by Qun 
    <span class="copyright-divider">|</span> 
    <span data-i18n="footer_ad">For more handy tools generated by AI, visit</span> 
    <a href="https://aifura.com" target="_blank">aifura.com</a>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>

<script>
  // ==================== I18N (Internationalization) ====================
  const translations = {
    zh: {
      title: "Image â‡„ PDF å·¥å…·ç®± V3",
      subtitle: "çº¯å‰ç«¯å¤„ç† Â· å®‰å…¨æ— ä¸Šä¼  Â· å¢å¼ºæ’ç‰ˆ",
      tab_i2p: "å›¾ç‰‡è½¬ PDF",
      tab_p2i: "PDF è½¬å›¾ç‰‡",
      click_upload: "ç‚¹å‡»é€‰æ‹©å›¾ç‰‡",
      click_upload_pdf: "ç‚¹å‡»ä¸Šä¼  PDF",
      or_drag: "æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤",
      img_support: "æ”¯æŒ JPG / PNG / WebP",
      pdf_support: "ä»…æ”¯æŒå•ä¸ª PDF æ–‡ä»¶",
      label_size: "é¡µé¢å°ºå¯¸",
      opt_auto: "åŸå›¾å°ºå¯¸ (æ— ç™½è¾¹/æœ€ä½³æ•ˆæœ)",
      opt_a4: "A4 æ ‡å‡†çº¸ (210x297mm)",
      opt_a5: "A5 æ ‡å‡†çº¸ (148x210mm)",
      hint_auto: "ğŸ” æ ¹æ®å›¾ç‰‡å¤§å°è‡ªåŠ¨ç”Ÿæˆ PDFï¼Œé€‚åˆå­˜æ¡£ã€‚",
      hint_std: "ğŸ–¨ï¸ é€‚åˆæ‰“å°ï¼Œæ”¯æŒé¡µè¾¹è·è°ƒæ•´ã€‚",
      label_margin: "é¡µè¾¹è·",
      unit_mm: "æ¯«ç±³ (mm)",
      label_align: "å›¾ç‰‡ä½ç½®",
      align_center: "å‚ç›´å±…ä¸­ (Center)",
      align_top: "é¡¶éƒ¨å¯¹é½ (Top)",
      align_bottom: "åº•éƒ¨å¯¹é½ (Bottom)",
      sect_selected: "å·²é€‰å›¾ç‰‡",
      btn_clear: "æ¸…ç©ºåˆ—è¡¨",
      empty_img: "æš‚æœªæ·»åŠ å›¾ç‰‡",
      status_ready: "å‡†å¤‡å°±ç»ª",
      btn_gen: "ç”Ÿæˆå¹¶ä¸‹è½½ PDF",
      sect_export: "é€‰æ‹©å¯¼å‡ºé¡µé¢",
      btn_all: "å…¨é€‰",
      btn_none: "å…¨ä¸é€‰",
      empty_pdf: "è¯·å…ˆä¸Šä¼  PDF æ–‡ä»¶",
      status_wait_pdf: "ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...",
      btn_export: "å¯¼å‡ºä¸º ZIP",
      footer_ad: "For more handy tools generated by AI, visit",
      // JS Alerts & Dynamic Strings
      js_reading: "æ­£åœ¨è¯»å– {n} å¼ å›¾ç‰‡...",
      js_loaded: "å›¾ç‰‡åŠ è½½å®Œæˆ",
      js_cleared: "åˆ—è¡¨å·²æ¸…ç©º",
      js_no_img: "è¯·å…ˆæ·»åŠ å›¾ç‰‡",
      js_generating: "æ­£åœ¨æ’ç‰ˆç”Ÿæˆ PDF...",
      js_margin_err: "é¡µè¾¹è·è®¾ç½®è¿‡å¤§ï¼Œå›¾ç‰‡æ— æ³•æ”¾ç½®",
      js_done: "PDF å·²ä¸‹è½½",
      js_fail: "ç”Ÿæˆå¤±è´¥",
      js_err: "ç”Ÿæˆå‡ºé”™ï¼š",
      js_parsing: "æ­£åœ¨è§£æ PDF...",
      js_parse_success: "è§£ææˆåŠŸï¼šå…± {n} é¡µ",
      js_parse_fail: "è§£æå¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåæˆ–åŠ å¯†",
      js_only_pdf: "è¯·åªä¸Šä¼  PDF æ–‡ä»¶",
      js_page: "ç¬¬ {n} é¡µ",
      js_sel_one: "è¯·è‡³å°‘é€‰æ‹©ä¸€é¡µ",
      js_exporting: "æ­£åœ¨å¯¼å‡º...",
      js_proc_page: "å¤„ç†ç¬¬ {n} é¡µ...",
      js_gen_zip: "ç”Ÿæˆ ZIP...",
      js_exp_done: "å¯¼å‡ºå®Œæˆ",
      js_exp_err: "å¯¼å‡ºå‡ºé”™"
    },
    en: {
      title: "Image â‡„ PDF Toolkit V3",
      subtitle: "Client-side only Â· Secure Â· Enhanced Layout",
      tab_i2p: "Image to PDF",
      tab_p2i: "PDF to Image",
      click_upload: "Select Images",
      click_upload_pdf: "Select PDF",
      or_drag: "or Drag & Drop here",
      img_support: "Supports JPG / PNG / WebP",
      pdf_support: "Supports single PDF file",
      label_size: "Page Size",
      opt_auto: "Original (No margins / Best Quality)",
      opt_a4: "A4 Standard (210x297mm)",
      opt_a5: "A5 Standard (148x210mm)",
      hint_auto: "ğŸ” Auto-size pages based on image. Good for archiving.",
      hint_std: "ğŸ–¨ï¸ Standard paper size for printing. Adjustable margins.",
      label_margin: "Margin",
      unit_mm: "mm",
      label_align: "Alignment",
      align_center: "Center",
      align_top: "Top",
      align_bottom: "Bottom",
      sect_selected: "Selected Images",
      btn_clear: "Clear All",
      empty_img: "No images added yet",
      status_ready: "Ready",
      btn_gen: "Generate & Download PDF",
      sect_export: "Select Pages to Export",
      btn_all: "Select All",
      btn_none: "Select None",
      empty_pdf: "Please upload a PDF first",
      status_wait_pdf: "Waiting for PDF upload...",
      btn_export: "Export as ZIP",
      footer_ad: "For more handy tools generated by AI, visit",
      // JS Alerts & Dynamic Strings
      js_reading: "Reading {n} images...",
      js_loaded: "Images loaded",
      js_cleared: "List cleared",
      js_no_img: "Please add images first",
      js_generating: "Generating PDF...",
      js_margin_err: "Margins are too large for the content",
      js_done: "PDF Downloaded",
      js_fail: "Generation Failed",
      js_err: "Error: ",
      js_parsing: "Parsing PDF...",
      js_parse_success: "Success: {n} pages found",
      js_parse_fail: "Failed to parse. File corrupted or encrypted.",
      js_only_pdf: "Please upload PDF files only",
      js_page: "Page {n}",
      js_sel_one: "Please select at least one page",
      js_exporting: "Exporting...",
      js_proc_page: "Processing Page {n}...",
      js_gen_zip: "Creating ZIP...",
      js_exp_done: "Export Completed",
      js_exp_err: "Export Error"
    }
  };

  let curLang = 'zh';

  function t(key, param) {
    let str = translations[curLang][key] || key;
    if (param !== undefined) str = str.replace('{n}', param);
    return str;
  }

  function toggleLanguage() {
    curLang = curLang === 'zh' ? 'en' : 'zh';
    document.getElementById('btn-lang').innerText = curLang === 'zh' ? 'EN' : 'ä¸­';
    applyLanguage();
  }

  function applyLanguage() {
    // 1. Update static DOM elements
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[curLang][key]) {
        el.innerText = translations[curLang][key];
      }
    });

    // 2. Update dynamic hints visibility based on current selection
    toggleAdvancedOptions();

    // 3. Update dynamic lists (to refresh "Empty" messages or "Page" labels)
    renderImgList();
    if(currentPdf) renderPdfPagesList();
    
    // 4. Update status texts if they are in "idle" state
    if (imgFiles.length === 0 && !document.getElementById('spinner-img').style.display === 'block') {
         document.getElementById('status-img').innerText = t('status_ready');
    }
    if (!currentPdf) {
         document.getElementById('status-pdf').innerText = t('status_wait_pdf');
    }
  }

  // ==================== UI Interactions ====================
  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const tabs = document.querySelectorAll('.tab');
    if(tabName === 'img2pdf') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');

    document.getElementById(`tab-${tabName}`).classList.add('active');
  }

  function toggleAdvancedOptions() {
    const mode = document.getElementById('pdf-size-mode').value;
    const advPanel = document.getElementById('advanced-options');
    const hintAuto = document.getElementById('hint-auto');
    const hintStd = document.getElementById('hint-standard');

    if (mode === 'auto') {
      advPanel.style.display = 'none';
      hintAuto.style.display = 'inline';
      hintStd.style.display = 'none';
    } else {
      advPanel.style.display = 'block';
      hintAuto.style.display = 'none';
      hintStd.style.display = 'inline';
    }
  }

  function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  // ==================== Logic: Image to PDF ====================
  let imgFiles = []; 
  const listImgEl = document.getElementById('list-img');
  const imgStatusEl = document.getElementById('status-img');
  const imgSpinner = document.getElementById('spinner-img');
  const btnGenPdf = document.getElementById('btn-gen-pdf');
  
  const sizeModeSelect = document.getElementById('pdf-size-mode');
  const marginInput = document.getElementById('pdf-margin');
  const alignSelect = document.getElementById('pdf-align');
  const inputImg = document.getElementById('input-img');
  const dropAreaImg = document.getElementById('drop-area-img');

  inputImg.addEventListener('change', e => handleImages(e.target.files));
  
  ['dragenter', 'dragover'].forEach(evt => {
    dropAreaImg.addEventListener(evt, e => { e.preventDefault(); dropAreaImg.classList.add('dragover'); });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropAreaImg.addEventListener(evt, e => { e.preventDefault(); dropAreaImg.classList.remove('dragover'); });
  });
  dropAreaImg.addEventListener('drop', e => handleImages(e.dataTransfer.files));

  async function handleImages(files) {
    const validFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
    if (validFiles.length === 0) return;

    setImgLoading(true, t('js_reading', validFiles.length));

    for (let file of validFiles) {
      try {
        const dataUrl = await readFileAsDataURL(file);
        const dim = await getImageDimensions(dataUrl);
        imgFiles.push({
          file,
          dataUrl,
          width: dim.width,
          height: dim.height,
          ratio: dim.width / dim.height,
          id: Date.now() + Math.random()
        });
      } catch (err) {
        console.error("Image load error", err);
      }
    }
    renderImgList();
    setImgLoading(false, t('js_loaded'));
    inputImg.value = ''; 
  }

  function renderImgList() {
    document.getElementById('img-count').innerText = `(${imgFiles.length})`;
    if (imgFiles.length === 0) {
      listImgEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">${t('empty_img')}</div>`;
      return;
    }
    listImgEl.innerHTML = '';
    imgFiles.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <img src="${item.dataUrl}" class="item-thumb">
        <div class="item-info">
          <div class="item-name">${item.file.name}</div>
          <div class="item-meta">${formatSize(item.file.size)} Â· ${item.width}x${item.height}</div>
        </div>
        <div class="item-actions">
          <button class="btn btn-sm" onclick="moveImg(${index}, -1)" ${index===0?'disabled':''}>â†‘</button>
          <button class="btn btn-sm" onclick="moveImg(${index}, 1)" ${index===imgFiles.length-1?'disabled':''}>â†“</button>
          <button class="btn btn-sm btn-danger" onclick="removeImg(${index})">âœ•</button>
        </div>
      `;
      listImgEl.appendChild(div);
    });
  }

  function moveImg(index, dir) {
    const temp = imgFiles[index];
    imgFiles[index] = imgFiles[index + dir];
    imgFiles[index + dir] = temp;
    renderImgList();
  }

  function removeImg(index) {
    imgFiles.splice(index, 1);
    renderImgList();
  }

  function clearImages() {
    imgFiles = [];
    renderImgList();
    imgStatusEl.innerText = t('js_cleared');
  }

  async function generatePDF() {
    if (imgFiles.length === 0) return alert(t('js_no_img'));
    
    setImgLoading(true, t('js_generating'));
    const mode = sizeModeSelect.value;
    const margin = parseInt(marginInput.value) || 0;
    const align = alignSelect.value;
    
    setTimeout(async () => {
      try {
        const { jsPDF } = window.jspdf;
        let doc = null;

        for (let i = 0; i < imgFiles.length; i++) {
          const img = imgFiles[i];
          const isLandscape = img.width > img.height;
          
          let format = 'JPEG';
          if (img.file.type === 'image/png') format = 'PNG';
          if (img.file.type === 'image/webp') format = 'WEBP';

          if (mode === 'auto') {
            if (i === 0) {
              doc = new jsPDF({
                orientation: isLandscape ? 'l' : 'p',
                unit: 'px',
                format: [img.width, img.height],
                hotfixes: ['px_scaling']
              });
            } else {
              doc.addPage([img.width, img.height], isLandscape ? 'l' : 'p');
            }
            doc.addImage(img.dataUrl, format, 0, 0, img.width, img.height);
          } else {
            const pageFormat = mode;
            const pageOrientation = isLandscape ? 'l' : 'p';
            if (i === 0) {
              doc = new jsPDF({ orientation: pageOrientation, unit: 'mm', format: pageFormat });
            } else {
              doc.addPage(pageFormat, pageOrientation);
            }
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const availWidth = pageWidth - (margin * 2);
            const availHeight = pageHeight - (margin * 2);

            if (availWidth <= 0 || availHeight <= 0) throw new Error(t('js_margin_err'));

            const imgRatio = img.width / img.height;
            const availRatio = availWidth / availHeight;
            let finalW, finalH;
            
            if (imgRatio > availRatio) {
                finalW = availWidth;
                finalH = finalW / imgRatio;
            } else {
                finalH = availHeight;
                finalW = finalH * imgRatio;
            }

            const x = (pageWidth - finalW) / 2;
            let y = margin;
            if (align === 'center') y = (pageHeight - finalH) / 2;
            else if (align === 'bottom') y = pageHeight - margin - finalH;

            doc.addImage(img.dataUrl, format, x, y, finalW, finalH);
          }
        }

        doc.save(`merged_${mode}.pdf`);
        setImgLoading(false, t('js_done'));
      } catch (err) {
        console.error(err);
        setImgLoading(false, t('js_fail'));
        alert(t('js_err') + err.message);
      }
    }, 100);
  }

  function setImgLoading(isLoading, text) {
    imgStatusEl.innerText = text;
    imgSpinner.style.display = isLoading ? 'block' : 'none';
    btnGenPdf.disabled = isLoading;
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function getImageDimensions(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve({ width: img.width, height: img.height });
      img.onerror = reject;
      img.src = url;
    });
  }

  // ==================== Logic: PDF to Image ====================
  let currentPdf = null;
  const listPdfPagesEl = document.getElementById('list-pdf-pages');
  const pdfStatusEl = document.getElementById('status-pdf');
  const pdfSpinner = document.getElementById('spinner-pdf');
  const btnExportImg = document.getElementById('btn-export-img');
  const dropAreaPdf = document.getElementById('drop-area-pdf');

  document.getElementById('input-pdf').addEventListener('change', e => handlePdf(e.target.files[0]));

  ['dragenter', 'dragover'].forEach(evt => {
    dropAreaPdf.addEventListener(evt, e => { e.preventDefault(); dropAreaPdf.classList.add('dragover'); });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropAreaPdf.addEventListener(evt, e => { e.preventDefault(); dropAreaPdf.classList.remove('dragover'); });
  });
  dropAreaPdf.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') handlePdf(file);
    else alert(t('js_only_pdf'));
  });

  async function handlePdf(file) {
    if (!file) return;
    setPdfLoading(true, t('js_parsing'));
    try {
      const buffer = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument(buffer);
      currentPdf = await loadingTask.promise;
      renderPdfPagesList();
      setPdfLoading(false, t('js_parse_success', currentPdf.numPages));
      btnExportImg.disabled = false;
    } catch (err) {
      console.error(err);
      setPdfLoading(false, t('js_parse_fail'));
    }
  }

  function renderPdfPagesList() {
    listPdfPagesEl.innerHTML = '';
    for (let i = 1; i <= currentPdf.numPages; i++) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<label class="page-item-label"><input type="checkbox" value="${i}" checked><span>${t('js_page', i)}</span></label>`;
      listPdfPagesEl.appendChild(div);
    }
  }

  function togglePdfPages(checked) {
    listPdfPagesEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
  }

  async function exportImages() {
    const cbs = Array.from(listPdfPagesEl.querySelectorAll('input[type="checkbox"]:checked'));
    if (cbs.length === 0) return alert(t('js_sel_one'));
    setPdfLoading(true, t('js_exporting'));
    const zip = new JSZip();
    try {
      for (const cb of cbs) {
        const pageNum = parseInt(cb.value);
        setPdfLoading(true, t('js_proc_page', pageNum));
        const page = await currentPdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2.0 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;
        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
        zip.file(`page_${String(pageNum).padStart(3,'0')}.jpg`, blob);
      }
      setPdfLoading(true, t('js_gen_zip'));
      const content = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = 'pdf_images.zip';
      a.click();
      setPdfLoading(false, t('js_exp_done'));
    } catch (err) {
      console.error(err);
      setPdfLoading(false, t('js_exp_err'));
    }
  }

  function setPdfLoading(isLoading, text) {
    pdfStatusEl.innerText = text;
    pdfSpinner.style.display = isLoading ? 'block' : 'none';
    if(isLoading) btnExportImg.disabled = true;
    else if(currentPdf) btnExportImg.disabled = false;
  }
</script>

</body>
</html>