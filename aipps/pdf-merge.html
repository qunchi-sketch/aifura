<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Merger / PDF 合并工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background: #f5f5f7;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #111827;
    }

    .app {
      max-width: 900px;
      width: 100%;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 24px 24px 16px;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .app-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .app-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .lang-switch {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #f9fafb;
    }

    .lang-btn {
      border: none;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #6b7280;
      transition: background 0.15s, color 0.15s;
    }

    .lang-btn.active {
      background: #111827;
      color: #ffffff;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 14px 14px 12px;
      border: 1px solid #e5e7eb;
    }

    .card:not(:last-child) {
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #111827;
    }

    .card-title span.step {
      font-size: 11px;
      background: #111827;
      color: #ffffff;
      border-radius: 999px;
      padding: 2px 6px;
    }

    .drop-zone {
      margin-top: 2px;
      border-radius: 10px;
      border: 1.5px dashed #cbd5f5;
      background: #eef2ff;
      padding: 18px 12px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
      font-size: 13px;
      color: #4b5563;
    }

    .drop-zone.dragover {
      border-color: #4f46e5;
      background: #e0e7ff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    .drop-zone strong {
      display: block;
      font-size: 13px;
      margin-bottom: 2px;
      color: #111827;
    }

    .hint {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
    }

    .primary-btn,
    .ghost-btn,
    .icon-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 7px 14px;
      white-space: nowrap;
      transition: background 0.12s, color 0.12s, box-shadow 0.12s, transform 0.06s;
    }

    .primary-btn {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.18);
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .primary-btn:not(:disabled):active {
      transform: translateY(1px);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.22);
    }

    .ghost-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      color: #6b7280;
      padding-left: 10px;
      padding-right: 10px;
    }

    .ghost-btn:hover {
      background: #f3f4f6;
    }

    .icon-btn {
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      font-size: 11px;
    }

    .icon-btn:hover {
      background: #e5e7eb;
    }

    .icon-btn.danger {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .icon-btn.danger:hover {
      background: #fee2e2;
    }

    .file-list {
      margin-top: 6px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 4px;
    }

    .file-list.empty {
      border-style: dashed;
      background: #f9fafb;
      padding: 10px 8px;
      font-size: 12px;
      color: #9ca3af;
    }

    .file-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 6px 6px;
      border-radius: 6px;
      transition: background 0.1s;
    }

    .file-row:nth-child(odd) {
      background: #f9fafb;
    }

    .file-main {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .file-name {
      font-size: 12px;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }

    .file-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .file-actions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
      margin-top: 4px;
    }

    .field-label {
      font-size: 12px;
      color: #4b5563;
    }

    .field input[type="text"] {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      background: #f9fafb;
    }

    .field input[type="text"]:focus {
      border-color: #4f46e5;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.18);
    }

    .page-size-options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      margin-top: 2px;
    }

    .page-size-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #4b5563;
      cursor: pointer;
    }

    .page-size-radio input {
      accent-color: #111827;
      cursor: pointer;
    }

    .status {
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
    }

    .status.info {
      color: #6b7280;
    }

    .status.success {
      color: #16a34a;
    }

    .status.error {
      color: #dc2626;
    }

    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title" data-i18n="title"></div>
        <div class="app-subtitle" data-i18n="subtitle"></div>
      </div>
      <div class="lang-switch" aria-label="Language switch">
        <button class="lang-btn active" data-lang="en" type="button">
          EN
        </button>
        <button class="lang-btn" data-lang="zh" type="button">
          中文
        </button>
      </div>
    </header>

    <div class="layout">
      <!-- 左侧：添加文件 + 文件列表 -->
      <div>
        <section class="card">
          <div class="card-title">
            <span class="step">1</span>
            <span data-i18n="step1Title"></span>
          </div>

          <div id="drop-zone" class="drop-zone">
            <strong data-i18n="dropTitle"></strong>
            <span data-i18n="dropSubtitle"></span>
          </div>

          <input
            type="file"
            id="file-input"
            accept="application/pdf"
            multiple
            hidden
          />

          <div class="actions-row">
            <button
              id="choose-files"
              class="primary-btn"
              type="button"
              data-i18n="chooseFiles"
            ></button>
          </div>

          <p class="hint" data-i18n="fileHint"></p>
        </section>

        <section class="card">
          <div class="card-title">
            <span class="step">2</span>
            <span data-i18n="step2Title"></span>
          </div>
          <div id="file-list" class="file-list empty">
            <p data-i18n="noFiles"></p>
          </div>
        </section>
      </div>

      <!-- 右侧：输出设置 + 尺寸选项 + 合并按钮 + 状态 -->
      <div>
        <section class="card">
          <div class="card-title">
            <span class="step">3</span>
            <span data-i18n="step3Title"></span>
          </div>

          <div class="field">
            <label for="output-name" class="field-label" data-i18n="outputNameLabel"></label>
            <input
              type="text"
              id="output-name"
              placeholder="merged.pdf"
              autocomplete="off"
            />
          </div>

          <div class="field">
            <div class="field-label" data-i18n="pageSizeTitle"></div>
            <div class="page-size-options">
              <label class="page-size-radio">
                <input
                  type="radio"
                  name="page-size"
                  value="original"
                  checked
                />
                <span data-i18n="pageSizeOriginal"></span>
              </label>
              <label class="page-size-radio">
                <input
                  type="radio"
                  name="page-size"
                  value="a4"
                />
                <span data-i18n="pageSizeA4"></span>
              </label>
            </div>
          </div>

          <div class="actions-row">
            <button
              id="merge-btn"
              class="primary-btn"
              type="button"
              data-i18n="mergeButton"
              disabled
            ></button>
            <button
              id="clear-btn"
              class="ghost-btn"
              type="button"
              data-i18n="clearButton"
            ></button>
          </div>

          <p id="status-text" class="status info"></p>
        </section>
      </div>
    </div>

    <div class="footer">
      Created by Qun
    </div>
  </div>

  <!-- pdf-lib 用于在浏览器里合并 PDF -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    const translations = {
      en: {
        title: "PDF Merger",
        subtitle: "Combine multiple PDF files into one, directly in your browser.",
        step1Title: "Add PDF files",
        dropTitle: "Drop PDF files here",
        dropSubtitle: "or use the button below to choose files",
        chooseFiles: "Choose PDF files",
        fileHint: "You can add multiple files at once. Only PDF files are supported.",
        step2Title: "Arrange merge order",
        noFiles: "No files yet. Add at least two PDF files to merge.",
        step3Title: "Merge & download",
        outputNameLabel: "Output file name",
        pageSizeTitle: "Page size",
        pageSizeOriginal: "Keep original page sizes",
        pageSizeA4: "Unify to A4 size (fit with white margins)",
        mergeButton: "Merge PDFs",
        clearButton: "Clear list",
        statusIdle: "Add at least two PDF files to get started.",
        statusFilesReady: "Ready: {{count}} file(s).",
        statusMerging: "Merging… This may take a moment for large files.",
        statusSuccess: "Done! Your merged PDF has been downloaded.",
        statusNeedMore: "Please add at least two PDF files.",
        statusWrongType: "Some files were ignored because they are not PDFs.",
        statusMergeError: "Something went wrong while merging. Please try again."
      },
      zh: {
        title: "PDF 合并工具",
        subtitle: "在浏览器中把多个 PDF 合并成一个文件。",
        step1Title: "添加 PDF 文件",
        dropTitle: "将 PDF 文件拖拽到这里",
        dropSubtitle: "或者点击下面按钮选择文件",
        chooseFiles: "选择 PDF 文件",
        fileHint: "可一次添加多个文件，仅支持 PDF 格式。",
        step2Title: "调整合并顺序",
        noFiles: "当前没有文件，请先添加至少两个 PDF。",
        step3Title: "合并并下载",
        outputNameLabel: "输出文件名",
        pageSizeTitle: "页面尺寸",
        pageSizeOriginal: "保持原始页面尺寸",
        pageSizeA4: "统一为 A4 尺寸（等比缩放，边缘留白）",
        mergeButton: "开始合并",
        clearButton: "清空列表",
        statusIdle: "请先添加至少两个 PDF 文件。",
        statusFilesReady: "已添加 {{count}} 个文件。",
        statusMerging: "正在合并，请稍候，大文件可能需要一点时间。",
        statusSuccess: "合并完成，已开始下载。",
        statusNeedMore: "请至少添加两个 PDF 文件。",
        statusWrongType: "部分文件已被忽略，因为它们不是 PDF。",
        statusMergeError: "合并时出错，请重试。"
      }
    };

    let currentLang = "zh"; // 默认中文
    let files = [];
    let pageSizeMode = "original"; // "original" | "a4"

    function t(key, params) {
      const dict = translations[currentLang] || translations.en;
      let str = dict[key] || key;
      if (params) {
        Object.entries(params).forEach(([k, v]) => {
          str = str.replace(`{{${k}}}`, v);
        });
      }
      return str;
    }

    function applyTranslations() {
      document.documentElement.lang =
        currentLang === "en" ? "en" : "zh-Hans";
      document
        .querySelectorAll("[data-i18n]")
        .forEach((el) => {
          const key = el.getAttribute("data-i18n");
          el.textContent = t(key);
        });
    }

    function formatBytes(bytes) {
      if (bytes === 0) return "0 B";
      const units = ["B", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + " " + units[i];
    }

    function updateStatus(key, params, type = "info") {
      const el = document.getElementById("status-text");
      el.textContent = t(key, params);
      el.className = "status " + type;
    }

    function renderFileList() {
      const list = document.getElementById("file-list");
      const mergeBtn = document.getElementById("merge-btn");

      list.innerHTML = "";

      if (!files.length) {
        list.classList.add("empty");
        const p = document.createElement("p");
        p.setAttribute("data-i18n", "noFiles");
        list.appendChild(p);
        applyTranslations(); // 让 noFiles 文案跟随当前语言
        mergeBtn.disabled = true;
        updateStatus("statusIdle", null, "info");
        return;
      }

      list.classList.remove("empty");

      files.forEach((file, index) => {
        const row = document.createElement("div");
        row.className = "file-row";

        const main = document.createElement("div");
        main.className = "file-main";

        const name = document.createElement("div");
        name.className = "file-name";
        name.textContent = file.name;

        const meta = document.createElement("div");
        meta.className = "file-meta";
        meta.textContent = formatBytes(file.size);

        main.appendChild(name);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "file-actions";

        const upBtn = document.createElement("button");
        upBtn.type = "button";
        upBtn.className = "icon-btn";
        upBtn.textContent = "↑";
        upBtn.dataset.action = "up";
        upBtn.dataset.index = index;

        const downBtn = document.createElement("button");
        downBtn.type = "button";
        downBtn.className = "icon-btn";
        downBtn.textContent = "↓";
        downBtn.dataset.action = "down";
        downBtn.dataset.index = index;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "icon-btn danger";
        removeBtn.textContent = "×";
        removeBtn.dataset.action = "remove";
        removeBtn.dataset.index = index;

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(removeBtn);

        row.appendChild(main);
        row.appendChild(actions);

        list.appendChild(row);
      });

      mergeBtn.disabled = files.length < 2;
      updateStatus(
        "statusFilesReady",
        { count: files.length },
        "info"
      );
    }

    function handleFiles(fileList) {
      const incoming = Array.from(fileList || []);
      if (!incoming.length) return;

      let ignored = false;
      const accepted = [];

      incoming.forEach((file) => {
        const isPdf =
          file.type === "application/pdf" ||
          file.name.toLowerCase().endsWith(".pdf");
        if (isPdf) {
          accepted.push(file);
        } else {
          ignored = true;
        }
      });

      if (!accepted.length && ignored) {
        updateStatus("statusWrongType", null, "error");
        return;
      }

      files = files.concat(accepted);
      renderFileList();
    }

    function setLoading(isLoading) {
      const mergeBtn = document.getElementById("merge-btn");
      const chooseBtn = document.getElementById("choose-files");

      mergeBtn.disabled = isLoading || files.length < 2;
      chooseBtn.disabled = isLoading;
      document.body.classList.toggle("loading", isLoading);
    }

    async function mergePdfs() {
      if (files.length < 2) {
        updateStatus("statusNeedMore", null, "error");
        return;
      }

      if (!window.PDFLib) {
        console.error("PDFLib not loaded");
        updateStatus("statusMergeError", null, "error");
        return;
      }

      setLoading(true);
      updateStatus("statusMerging", null, "info");

      try {
        const { PDFDocument } = PDFLib;
        const mergedPdf = await PDFDocument.create();

        if (pageSizeMode === "original") {
          // 模式一：保持原始页面尺寸，直接 copyPages
          for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await PDFDocument.load(arrayBuffer);
            const copiedPages = await mergedPdf.copyPages(
              pdf,
              pdf.getPageIndices()
            );
            copiedPages.forEach((page) => mergedPdf.addPage(page));
          }
        } else if (pageSizeMode === "a4") {
          // 模式二：统一为 A4 尺寸（竖版），等比缩放 + 居中 + 白边
          const A4_WIDTH = 595;  // 近似 A4 宽（pt）
          const A4_HEIGHT = 842; // 近似 A4 高（pt）

          for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            const srcPdf = await PDFDocument.load(arrayBuffer);
            const srcPages = srcPdf.getPages();

            for (const srcPage of srcPages) {
              // 将源页面嵌入到目标文档
              const embeddedPage = await mergedPdf.embedPage(srcPage);
              const { width, height } = embeddedPage; // 原页面尺寸

              // 等比缩放，保证内容完整保留
              const scale = Math.min(A4_WIDTH / width, A4_HEIGHT / height);
              const scaledDims = embeddedPage.scale(scale);

              const page = mergedPdf.addPage([A4_WIDTH, A4_HEIGHT]);

              const x = (A4_WIDTH - scaledDims.width) / 2;
              const y = (A4_HEIGHT - scaledDims.height) / 2;

              // 在 A4 白纸上居中绘制该页面
              page.drawPage(embeddedPage, {
                x,
                y,
                width: scaledDims.width,
                height: scaledDims.height
              });
            }
          }
        }

        const mergedBytes = await mergedPdf.save();
        const blob = new Blob([mergedBytes], {
          type: "application/pdf"
        });

        const nameInput = document.getElementById("output-name");
        let fileName = (nameInput.value || "").trim() || "merged.pdf";
        if (!fileName.toLowerCase().endsWith(".pdf")) {
          fileName += ".pdf";
        }

        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);

        updateStatus("statusSuccess", null, "success");
      } catch (err) {
        console.error(err);
        updateStatus("statusMergeError", null, "error");
      } finally {
        setLoading(false);
      }
    }

    // 初始化事件绑定
    function init() {
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const chooseBtn = document.getElementById("choose-files");
      const mergeBtn = document.getElementById("merge-btn");
      const clearBtn = document.getElementById("clear-btn");
      const fileList = document.getElementById("file-list");

      // 语言切换
      document
        .querySelectorAll(".lang-btn")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const lang = btn.dataset.lang;
            if (!lang || lang === currentLang) return;
            currentLang = lang;
            document
              .querySelectorAll(".lang-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            applyTranslations();
            // 重绘列表，让空状态等文案切换语言
            renderFileList();
          });
        });

      // 页面尺寸单选项
      document
        .querySelectorAll('input[name="page-size"]')
        .forEach((radio) => {
          radio.addEventListener("change", () => {
            if (radio.checked) {
              pageSizeMode = radio.value === "a4" ? "a4" : "original";
            }
          });
        });

      // 初始语言应用
      applyTranslations();
      updateStatus("statusIdle", null, "info");

      // 选择文件按钮
      chooseBtn.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
        fileInput.value = ""; // 允许选择同一文件多次
      });

      // 拖拽事件
      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });
      });

      ["dragleave", "dragend"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("dragover");
        });
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("dragover");
        const dt = e.dataTransfer;
        if (dt && dt.files) {
          handleFiles(dt.files);
        }
      });

      // 文件列表上的按钮（上移 / 下移 / 删除）
      fileList.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        const action = target.dataset.action;
        const index = Number(target.dataset.index);
        if (Number.isNaN(index)) return;

        if (action === "up" && index > 0) {
          const tmp = files[index - 1];
          files[index - 1] = files[index];
          files[index] = tmp;
          renderFileList();
        } else if (action === "down" && index < files.length - 1) {
          const tmp = files[index + 1];
          files[index + 1] = files[index];
          files[index] = tmp;
          renderFileList();
        } else if (action === "remove") {
          files.splice(index, 1);
          renderFileList();
        }
      });

      // 合并按钮
      mergeBtn.addEventListener("click", () => {
        mergePdfs();
      });

      // 清空列表
      clearBtn.addEventListener("click", () => {
        files = [];
        renderFileList();
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
