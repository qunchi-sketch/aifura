<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2L2QE301LP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2L2QE301LP');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Close Reading Tool - Powered by Aifura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .article-content { font-family: 'Georgia', serif; line-height: 1.8; }
        .highlight-vocab { background-color: #fee2e2; border-bottom: 2px solid #ef4444; cursor: pointer; }
        .highlight-sentence { background-color: #fef9c3; border-bottom: 2px solid #eab308; cursor: pointer; }
        @keyframes flash-focus {
            0%, 100% { background-color: transparent; }
            50% { background-color: #bae6fd; }
        }
        .flash-target { animation: flash-focus 1s ease-in-out 3; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { scrollbar-width: none; }
        
        /* 增加一个打印/导出时的特定样式，确保水印清晰 */
        .brand-footer {
            background: linear-gradient(to right, #eff6ff, #ffffff);
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

<div id="root"></div>

<script type="text/babel">

    const Icon = ({ name, size = 16, color = "currentColor", className="" }) => {
        React.useEffect(() => { lucide.createIcons(); }, []);
        return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
    };

    // --- 笔记卡片组件 ---
    const NoteCard = ({ item, type, onDelete, onLocate, onUpdateNote }) => {
        const [isEditing, setIsEditing] = React.useState(false);
        const [noteText, setNoteText] = React.useState(item.note || "");

        const handleSave = () => {
            onUpdateNote(item.id, noteText);
            setIsEditing(false);
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSave();
            }
        };

        const borderClass = type === 'vocab' ? 'border-red-200 hover:shadow-red-100' : 'border-l-4 border-yellow-400';
        const bgClass = 'bg-white';
        const titleColor = type === 'vocab' ? 'text-gray-800' : 'text-gray-700 italic';

        return (
            <div className={`group relative ${bgClass} ${borderClass} ${type === 'vocab' ? 'border' : ''} rounded-lg shadow-sm p-4 hover:shadow-md transition`}>
                <div className="flex justify-between items-start gap-2">
                    <div onClick={() => onLocate(item.id)} className={`cursor-pointer ${titleColor} font-medium flex-1 hover:underline decoration-dotted`}>
                        {item.text}
                    </div>
                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onClick={() => setIsEditing(!isEditing)} className="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Edit Note">
                            <Icon name="edit-3" size={14}/>
                        </button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded" title="Delete">
                            <Icon name="trash-2" size={14}/>
                        </button>
                    </div>
                </div>
                {!isEditing && item.note && (
                    <div className="mt-2 pt-2 border-t border-dashed border-gray-200 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                        <span className="font-semibold text-xs text-gray-400 block mb-1">NOTES:</span>{item.note}
                    </div>
                )}
                {isEditing && (
                    <div className="mt-3 animate-in fade-in slide-in-from-top-2 duration-200">
                        <textarea className="w-full p-2 text-sm border border-blue-300 rounded focus:ring-2 focus:ring-blue-100 outline-none resize-none bg-blue-50" rows="2" placeholder="Write your note..." value={noteText} onChange={(e) => setNoteText(e.target.value)} onKeyDown={handleKeyDown} autoFocus />
                        <div className="flex justify-end gap-2 mt-2">
                             <button onClick={() => setIsEditing(false)} className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1">Cancel</button>
                            <button onClick={handleSave} className="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Save</button>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // --- 主应用组件 ---
    function App() {
        const [articleText, setArticleText] = React.useState("");
        const [vocabList, setVocabList] = React.useState([]);
        const [sentenceList, setSentenceList] = React.useState([]);
        const [toolbarPosition, setToolbarPosition] = React.useState(null);
        const [isImporting, setIsImporting] = React.useState(true);
        const articleRef = React.useRef(null);
        const currentSelectionRange = React.useRef(null);

        const handleInputChange = (e) => setArticleText(e.target.value);
        const startReading = () => { if (articleText.trim()) setIsImporting(false); };
        
        const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => setArticleText(ev.target.result);
                reader.readAsText(file);
            }
        };

        const handleMouseUp = () => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (selectedText.length > 0 && articleRef.current.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const articleRect = articleRef.current.getBoundingClientRect();
                setToolbarPosition({ top: rect.top - articleRect.top - 45, left: rect.left - articleRect.left + (rect.width / 2) });
                currentSelectionRange.current = range;
            } else {
                setToolbarPosition(null);
                currentSelectionRange.current = null;
            }
        };

        const applyHighlight = (type) => {
            if (!currentSelectionRange.current) return;
            const range = currentSelectionRange.current;
            const selectedText = range.toString();
            const uniqueId = `note-${Date.now()}`;
            const span = document.createElement("span");
            span.className = type === 'vocab' ? 'highlight-vocab' : 'highlight-sentence';
            span.id = uniqueId;
            span.textContent = selectedText;

            try {
                range.deleteContents();
                range.insertNode(span);
            } catch (e) {
                alert("Please select text within a single paragraph.");
                return;
            }

            const newItem = { id: uniqueId, text: selectedText, note: "" };
            if (type === 'vocab') setVocabList([...vocabList, newItem]);
            else setSentenceList([...sentenceList, newItem]);

            window.getSelection().removeAllRanges();
            setToolbarPosition(null);
            currentSelectionRange.current = null;
        };

        const deleteNote = (id, type) => {
            const spanElement = document.getElementById(id);
            if (spanElement) {
                const parent = spanElement.parentNode;
                while (spanElement.firstChild) parent.insertBefore(spanElement.firstChild, spanElement);
                parent.removeChild(spanElement);
                parent.normalize();
            }
            if (type === 'vocab') setVocabList(vocabList.filter(item => item.id !== id));
            else setSentenceList(sentenceList.filter(item => item.id !== id));
        };

        const scrollToHighlight = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('flash-target');
                setTimeout(() => element.classList.remove('flash-target'), 2000);
            }
        };

        const updateNoteContent = (id, type, newContent) => {
            if (type === 'vocab') setVocabList(vocabList.map(item => item.id === id ? { ...item, note: newContent } : item));
            else setSentenceList(sentenceList.map(item => item.id === id ? { ...item, note: newContent } : item));
        };

        const exportPDF = () => {
            const element = document.getElementById('export-container');
            const opt = {
                margin: 5,
                filename: 'reading-notes-aifura.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            const headerBtn = document.getElementById('export-btn-group');
            if(headerBtn) headerBtn.style.display = 'none';
            html2pdf().set(opt).from(element).save().then(() => {
                if(headerBtn) headerBtn.style.display = 'flex';
            });
        };

        if (isImporting) {
            return (
                <div className="flex flex-col items-center justify-center h-full p-8 bg-gray-50 relative overflow-hidden">
                    {/* 背景装饰 */}
                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                    
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl text-center z-10">
                        <h1 className="text-3xl font-bold mb-2 text-gray-800 flex justify-center items-center gap-2">
                            <Icon name="book-open" size={32}/> English Reading Pro
                        </h1>
                        <p className="text-gray-400 text-sm mb-6">沉浸式精读 & 笔记整理工具</p>
                        
                        <textarea className="w-full h-64 p-4 border border-gray-300 rounded-md resize-none mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="在此粘贴文章内容..." value={articleText} onChange={handleInputChange} />
                         
                         <div className="flex gap-4 justify-center">
                            <label className="px-4 py-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50 flex items-center gap-2">
                                <Icon name="upload" size={16}/> 导入TXT
                                <input type="file" accept=".txt" onChange={handleFileUpload} className="hidden" />
                            </label>
                            <button onClick={startReading} disabled={!articleText.trim()} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 shadow-lg shadow-blue-200">
                                开始精读
                            </button>
                        </div>
                    </div>
                    
                    {/* 首页底部宣传 */}
                    <div className="mt-8 text-gray-400 text-sm">
                        For more handy tools visit: <a href="https://aifura.com" target="_blank" className="text-blue-500 hover:underline font-medium">aifura.com</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="h-full flex flex-col">
                <header className="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-10">
                    <div className="flex items-center gap-2">
                        <Icon name="layers" size={20} className="text-blue-600"/>
                        <span className="font-bold text-gray-800">Reading Dashboard</span>
                    </div>
                    <div id="export-btn-group" className="flex gap-3">
                         <button onClick={() => setIsImporting(true)} className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded flex items-center gap-1">
                            <Icon name="arrow-left" size={16}/> Back
                        </button>
                        <button onClick={exportPDF} className="px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded shadow flex items-center gap-2">
                            <Icon name="download" size={18} /> Export PDF
                        </button>
                    </div>
                </header>

                <div id="export-container" className="flex-1 flex overflow-hidden bg-gray-100">
                    <main className="flex-1 overflow-y-auto p-8 no-scrollbar" onMouseUp={handleMouseUp}>
                        <div className="max-w-3xl mx-auto bg-white p-12 rounded-xl shadow-sm min-h-full relative">
                            {toolbarPosition && (
                                <div className="absolute z-20 bg-gray-900 text-white rounded shadow-lg flex -translate-x-1/2" style={{ top: toolbarPosition.top, left: toolbarPosition.left }}>
                                    <button onClick={() => applyHighlight('vocab')} className="px-3 py-1.5 hover:bg-gray-700 border-r border-gray-700 text-sm flex items-center gap-1">
                                        <span className="w-2 h-2 rounded-full bg-red-400"></span> Vocab
                                    </button>
                                    <button onClick={() => applyHighlight('sentence')} className="px-3 py-1.5 hover:bg-gray-700 text-sm flex items-center gap-1">
                                        <span className="w-2 h-2 rounded-full bg-yellow-400"></span> Sentence
                                    </button>
                                </div>
                            )}
                            <div ref={articleRef} className="article-content text-lg text-gray-800 whitespace-pre-wrap" dangerouslySetInnerHTML={{ __html: articleText }} />
                        </div>
                    </main>

                    <aside className="w-[35%] min-w-[350px] bg-gray-50 border-l border-gray-200 overflow-y-auto no-scrollbar flex flex-col">
                        <div className="p-5 flex-1 flex flex-col gap-6">
                            {/* 生词列表 */}
                            <div>
                                <h2 className="text-sm font-bold uppercase tracking-wider text-gray-500 mb-3 flex items-center justify-between">
                                    <span>Vocabulary</span>
                                    <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs">{vocabList.length}</span>
                                </h2>
                                <div className="flex flex-col gap-3">
                                    {vocabList.map(item => (
                                        <NoteCard key={item.id} item={item} type="vocab" onDelete={(id) => deleteNote(id, 'vocab')} onLocate={scrollToHighlight} onUpdateNote={(id, note) => updateNoteContent(id, 'vocab', note)} />
                                    ))}
                                    {vocabList.length === 0 && <div className="text-center py-6 text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded">Highlight words to add here</div>}
                                </div>
                            </div>
                            
                            {/* 黄金句型列表 */}
                            <div>
                                <h2 className="text-sm font-bold uppercase tracking-wider text-gray-500 mb-3 flex items-center justify-between">
                                    <span>Golden Sentences</span>
                                    <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs">{sentenceList.length}</span>
                                </h2>
                                <div className="flex flex-col gap-4">
                                    {sentenceList.map(item => (
                                        <NoteCard key={item.id} item={item} type="sentence" onDelete={(id) => deleteNote(id, 'sentence')} onLocate={scrollToHighlight} onUpdateNote={(id, note) => updateNoteContent(id, 'sentence', note)} />
                                    ))}
                                    {sentenceList.length === 0 && <div className="text-center py-6 text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded">Highlight sentences to add here</div>}
                                </div>
                            </div>
                        </div>

                        {/* --- 宣传 Footer (在侧边栏底部，会被导出到PDF) --- */}
                        <div className="p-4 mt-auto border-t border-gray-200 brand-footer">
                            <div className="flex flex-col items-center justify-center gap-1 text-center">
                                <p className="text-xs text-gray-500 font-medium">✨ Boost your productivity</p>
                                <a href="https://aifura.com" target="_blank" className="text-sm font-bold text-blue-600 hover:text-blue-800 transition flex items-center gap-1">
                                    For more handy tools visit: aifura.com <Icon name="external-link" size={12}/>
                                </a>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>

</html>
