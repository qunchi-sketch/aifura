<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å›¾ç‰‡å‹ç¼© - Image Compressor | Aifura</title>
  <meta name="description" content="å…è´¹åœ¨çº¿å›¾ç‰‡å‹ç¼©å·¥å…·ï¼šæ‰¹é‡å‹ç¼© JPG/PNG/WebPï¼Œä¸‰ç§æ¨¡å¼ï¼ˆç¤¾äº¤/ç”µå•†/æé™ï¼‰ï¼ŒåŸå›¾ä¸å‹ç¼©åå¯¹æ¯”é¢„è§ˆã€‚Free online image compressor." />
  <style>
    :root{--bg:#0b0f19;--card:#121a2a;--muted:#8aa0c1;--text:#e8f0ff;--line:#23324f;--btn:#2c6cff;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);}
    a{color:#9bc1ff;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{font-weight:700;letter-spacing:.3px}
    .lang{display:flex;gap:8px}
    .lang button{background:transparent;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .lang button.active{border-color:#7fb0ff;background:#0f1b33}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:14px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .drop{border:2px dashed #35507b;border-radius:16px;padding:18px;min-height:160px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;text-align:center}
    .drop.drag{background:#0f1b33}
    .btn{background:var(--btn);color:white;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid var(--line);color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted);font-size:13px;line-height:1.4}
    .modes{display:flex;gap:10px;flex-wrap:wrap}
    .mode{flex:1;min-width:220px;border:1px solid var(--line);border-radius:14px;padding:12px;cursor:pointer}
    .mode.active{border-color:#7fb0ff;background:#0f1b33}
    .mode h4{margin:0 0 6px 0}
    .mode p{margin:0;color:var(--muted);font-size:13px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px}
    .itemTop{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .name{font-weight:650}
    .meta{color:var(--muted);font-size:12px}
    .prog{height:8px;background:#0a1222;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;}
    .preview{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .pv{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0a1222}
    .pvHead{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px}
    .pv img{display:block;width:100%;height:220px;object-fit:contain;background:#070b14}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1b33;border:1px solid var(--line);padding:10px 12px;border-radius:12px;color:var(--text);display:none;max-width:92vw}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Aifura Tools Â· å›¾ç‰‡å‹ç¼© / Image Compressor</div>
      <div class="lang">
        <button id="btnCN" class="active">ä¸­æ–‡</button>
        <button id="btnEN">EN</button>
      </div>
    </div>

    <div class="card grid">
      <div>
        <div id="drop" class="drop">
          <div id="dropTitle" style="font-size:18px;font-weight:700">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
          <div id="dropSub" class="hint">æ”¯æŒ JPG / PNG / WebPï¼Œå•æ¬¡æœ€å¤š 20 å¼ ã€‚å¤„ç†åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚</div>
          <div class="row">
            <input id="file" type="file" accept="image/jpeg,image/png,image/webp" multiple hidden />
            <button id="pick" class="btn">é€‰æ‹©å›¾ç‰‡</button>
            <button id="clear" class="btn secondary">æ¸…ç©º</button>
          </div>
          <div class="row">
            <span id="stat" class="pill">0 files</span>
            <span id="privacy" class="pill">ğŸ”’ æœ¬åœ°å¤„ç† / Local</span>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div style="font-weight:700" id="modeTitle">å‹ç¼©æ¨¡å¼</div>
          <button id="start" class="btn" disabled>å¼€å§‹å‹ç¼©</button>
        </div>
        <div class="hint" id="modeHint" style="margin-top:6px">ä¸éœ€è¦ç†è§£å‚æ•°ï¼Œé€‰æ‹©ä½¿ç”¨åœºæ™¯å³å¯ã€‚</div>

        <div class="modes" style="margin-top:12px">
          <div class="mode active" data-mode="social">
            <h4 id="m1t">ğŸ“± ç¤¾äº¤/é€šç”¨ä¸Šä¼ ï¼ˆé»˜è®¤ï¼‰</h4>
            <p id="m1d">ç›®æ ‡ â‰¤ 1MBï¼Œé€‚åˆå¾®ä¿¡/å°çº¢ä¹¦/é‚®ä»¶ã€‚</p>
          </div>
          <div class="mode" data-mode="ecom">
            <h4 id="m2t">ğŸ›’ ç”µå•†æ¸…æ™°ä¼˜å…ˆ</h4>
            <p id="m2d">ç›®æ ‡ â‰¤ 2MBï¼Œé¢œè‰²ä¸ç»†èŠ‚æ›´ä¼˜å…ˆã€‚</p>
          </div>
          <div class="mode" data-mode="tiny">
            <h4 id="m3t">âš¡ æé™å‹ç¼©</h4>
            <p id="m3d">ç›®æ ‡ â‰¤ 500KBï¼Œç”»è´¨å¯èƒ½ç•¥é™ã€‚</p>
          </div>
        </div>

        <div class="footer">
          <div>æ›´å¤šå¥½ç”¨å·¥å…·è¯·è®¿é—®ï¼š<a href="https://aifura.com" target="_blank" rel="noopener">aifura.com</a></div>
          <div id="note">V1ï¼šä¸ºä¿è¯ç¨³å®šä¸é›¶ä¾èµ–ï¼ŒZIP æ‰“åŒ…æš‚æ”¹ä¸ºé€ä¸ªä¸‹è½½</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:700" id="listTitle">å¤„ç†é˜Ÿåˆ—</div>
        <div class="row">
          <button id="zipAll" class="btn secondary" disabled>æ‰“åŒ…ä¸‹è½½ ZIP</button>
        </div>
      </div>
      <div id="list" class="list" style="margin-top:12px"></div>
      <div id="empty" class="hint" style="margin-top:10px">è¿˜æ²¡æœ‰å›¾ç‰‡ã€‚ä¸Šä¼ åä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºé˜Ÿåˆ—ä¸å¯¹æ¯”é¢„è§ˆã€‚</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** ===========================
 *  Aifura Image Compressor (V1) - Inline Worker Edition
 *  - Single HTML file, no external scripts
 *  - Web Worker is embedded as Blob to avoid CF Pages fallback/MIME issues
 * ============================ */

const $ = (id) => document.getElementById(id);

const state = {
  lang: 'cn',
  mode: 'social',
  files: [], // {id, file, name, type, size, urlOriginal, result?}
  worker: null,
  busy: false,
};

const STR = {
  cn: {
    dropTitle: 'æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ',
    dropSub: 'æ”¯æŒ JPG / PNG / WebPï¼Œå•æ¬¡æœ€å¤š 20 å¼ ã€‚å¤„ç†åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚',
    pick: 'é€‰æ‹©å›¾ç‰‡',
    clear: 'æ¸…ç©º',
    modeTitle: 'å‹ç¼©æ¨¡å¼',
    modeHint: 'ä¸éœ€è¦ç†è§£å‚æ•°ï¼Œé€‰æ‹©ä½¿ç”¨åœºæ™¯å³å¯ã€‚',
    m1t:'ğŸ“± ç¤¾äº¤/é€šç”¨ä¸Šä¼ ï¼ˆé»˜è®¤ï¼‰', m1d:'ç›®æ ‡ â‰¤ 1MBï¼Œé€‚åˆå¾®ä¿¡/å°çº¢ä¹¦/é‚®ä»¶ã€‚',
    m2t:'ğŸ›’ ç”µå•†æ¸…æ™°ä¼˜å…ˆ', m2d:'ç›®æ ‡ â‰¤ 2MBï¼Œé¢œè‰²ä¸ç»†èŠ‚æ›´ä¼˜å…ˆã€‚',
    m3t:'âš¡ æé™å‹ç¼©', m3d:'ç›®æ ‡ â‰¤ 500KBï¼Œç”»è´¨å¯èƒ½ç•¥é™ã€‚',
    start:'å¼€å§‹å‹ç¼©',
    listTitle:'å¤„ç†é˜Ÿåˆ—',
    zip:'æ‰“åŒ…ä¸‹è½½ ZIP',
    empty:'è¿˜æ²¡æœ‰å›¾ç‰‡ã€‚ä¸Šä¼ åä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºé˜Ÿåˆ—ä¸å¯¹æ¯”é¢„è§ˆã€‚',
    local:'ğŸ”’ æœ¬åœ°å¤„ç†',
    fileCount:(n)=> `${n} files`,
    compressing:'å‹ç¼©ä¸­â€¦',
    done:(from,to,scene)=> `âœ… ä» ${from} å‹ç¼©è‡³ ${to}ï¼Œé€‚åˆ ${scene}`,
    retry:'é‡è¯•',
    download:'ä¸‹è½½',
    remove:'ç§»é™¤',
    scene_social:'å¾®ä¿¡/å°çº¢ä¹¦/é‚®ä»¶',
    scene_ecom:'ç”µå•†å¹³å°/å•†å“å›¾',
    scene_tiny:'å¿«é€Ÿä¸Šä¼ ï¼ˆæé™ï¼‰',
    toastZip:'V1 ä¸ºä¿è¯é›¶ä¾èµ–ä¸ç¨³å®šæ€§ï¼ŒZIP æš‚æ”¹ä¸ºé€ä¸ªä¸‹è½½ï¼ˆåç»­å¯åŠ  JSZip æœ¬åœ°ç‰ˆï¼‰ã€‚'
  },
  en: {
    dropTitle: 'Drop images here',
    dropSub: 'JPG / PNG / WebP. Up to 20 files. Processed locally, not uploaded.',
    pick: 'Choose Images',
    clear: 'Clear',
    modeTitle: 'Compression Mode',
    modeHint: 'Pick a scenario. No confusing parameters.',
    m1t:'ğŸ“± Social / General (Default)', m1d:'Target â‰¤ 1MB. Great for chat & social uploads.',
    m2t:'ğŸ›’ Ecommerce (Clarity First)', m2d:'Target â‰¤ 2MB. Better detail & color.',
    m3t:'âš¡ Ultra Small', m3d:'Target â‰¤ 500KB. Slight quality loss possible.',
    start:'Compress',
    listTitle:'Queue',
    zip:'Download ZIP',
    empty:'No images yet. Upload to see queue and previews.',
    local:'ğŸ”’ Local processing',
    fileCount:(n)=> `${n} files`,
    compressing:'Compressingâ€¦',
    done:(from,to,scene)=> `âœ… ${from} â†’ ${to}. Good for ${scene}`,
    retry:'Retry',
    download:'Download',
    remove:'Remove',
    scene_social:'social/email uploads',
    scene_ecom:'ecommerce product images',
    scene_tiny:'quick upload (tiny)',
    toastZip:'For stability (no external libs), ZIP is temporarily replaced with sequential downloads.'
  }
};

function toast(msg){
  const el = $('toast');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ el.style.display = 'none'; }, 2500);
}

function fmtBytes(bytes){
  if (!Number.isFinite(bytes)) return '-';
  const units = ['B','KB','MB','GB'];
  let b = bytes, i = 0;
  while(b>=1024 && i<units.length-1){ b/=1024; i++; }
  const v = (i===0) ? String(Math.round(b)) : b.toFixed(b<10?2:(b<100?1:0));
  return `${v} ${units[i]}`;
}

function sceneLabel(){
  const t = STR[state.lang];
  if (state.mode === 'social') return t.scene_social;
  if (state.mode === 'ecom') return t.scene_ecom;
  return t.scene_tiny;
}

function setLang(lang){
  state.lang = lang;
  const t = STR[lang];
  $('dropTitle').textContent = t.dropTitle;
  $('dropSub').textContent = t.dropSub;
  $('pick').textContent = t.pick;
  $('clear').textContent = t.clear;
  $('modeTitle').textContent = t.modeTitle;
  $('modeHint').textContent = t.modeHint;
  $('m1t').textContent = t.m1t; $('m1d').textContent = t.m1d;
  $('m2t').textContent = t.m2t; $('m2d').textContent = t.m2d;
  $('m3t').textContent = t.m3t; $('m3d').textContent = t.m3d;
  $('start').textContent = t.start;
  $('listTitle').textContent = t.listTitle;
  $('zipAll').textContent = t.zip;
  $('empty').textContent = t.empty;
  $('privacy').textContent = t.local;
  $('stat').textContent = t.fileCount(state.files.length);
  renderList();
}

function setMode(mode){
  state.mode = mode;
  document.querySelectorAll('.mode').forEach(el=>{
    el.classList.toggle('active', el.dataset.mode === mode);
  });
}

/** ---------- Inline Worker ---------- */
function ensureWorker(){
  if (state.worker) return;

  // ä¸ç”¨åå¼•å·ï¼Œé¿å…å¤åˆ¶æ—¶å‡ºç°â€œéæ³•å­—ç¬¦â€
  const workerLines = [
    "self.onmessage = async (ev) => {",
    "  const msg = ev.data;",
    "  if (!msg || !msg.type) return;",
    "  try {",
    "    if (msg.type === 'QUEUE') {",
    "      const profile = msg.profile;",
    "      const prefer = msg.prefer;",
    "      const items = msg.items || [];",
    "      for (let i = 0; i < items.length; i++) {",
    "        await processOne(items[i], profile, prefer);",
    "      }",
    "      self.postMessage({ type: 'ALL_DONE' });",
    "      return;",
    "    }",
    "    if (msg.type === 'ONE') {",
    "      const profile = msg.profile;",
    "      const prefer = msg.prefer;",
    "      const item = msg.item;",
    "      await processOne(item, profile, prefer);",
    "      return;",
    "    }",
    "  } catch (err) {",
    "    const id = (msg && msg.item && msg.item.id) ? msg.item.id : undefined;",
    "    self.postMessage({ type: 'ERROR', id: id, error: String((err && err.message) ? err.message : err) });",
    "  }",
    "};",

    "async function processOne(item, profile, prefer) {",
    "  const id = item.id;",
    "  const type = item.type;",
    "  const buffer = item.buffer;",
    "  self.postMessage({ type: 'PROGRESS', id: id, progress: 5 });",
    "  const blob = new Blob([buffer], { type: type });",
    "  const bitmap = await createImageBitmap(blob);",
    "  self.postMessage({ type: 'PROGRESS', id: id, progress: 20 });",

    "  const maxEdge = clamp((profile && profile.maxEdge) ? profile.maxEdge : 2400, 800, 6000);",
    "  const w0 = bitmap.width, h0 = bitmap.height;",
    "  let w = w0, h = h0;",
    "  const longEdge = Math.max(w0, h0);",
    "  if (longEdge > maxEdge) {",
    "    const scale = maxEdge / longEdge;",
    "    w = Math.max(1, Math.round(w0 * scale));",
    "    h = Math.max(1, Math.round(h0 * scale));",
    "  }",

    "  const canvas = new OffscreenCanvas(w, h);",
    "  const ctx = canvas.getContext('2d', { alpha: true, desynchronized: true });",
    "  ctx.drawImage(bitmap, 0, 0, w, h);",
    "  if (bitmap.close) bitmap.close();",
    "  self.postMessage({ type: 'PROGRESS', id: id, progress: 45 });",

    "  const targetBytes = clamp((profile && profile.targetBytes) ? profile.targetBytes : 1024 * 1024, 100 * 1024, 10 * 1024 * 1024);",
    "  const outType = pickOutputType(type, prefer);",
    "  const result = await encodeToTarget(canvas, outType, targetBytes, prefer, (p) => {",
    "    self.postMessage({ type: 'PROGRESS', id: id, progress: p });",
    "  });",

    "  const outBuf = await result.blob.arrayBuffer();",
    "  self.postMessage({ type: 'DONE', id: id, outBlob: outBuf, outType: result.type, outSize: result.size, width: w, height: h }, [outBuf]);",
    "}",

    "function pickOutputType(inputType, prefer) {",
    "  const isPng = inputType === 'image/png';",
    "  const isJpeg = inputType === 'image/jpeg';",
    "  const isWebp = inputType === 'image/webp';",
    "  if (prefer === 'tiny' || prefer === 'ecom') return 'image/webp';",
    "  if (prefer === 'social') {",
    "    if (isJpeg) return 'image/jpeg';",
    "    if (isPng) return 'image/webp';",
    "    if (isWebp) return 'image/webp';",
    "  }",
    "  return 'image/webp';",
    "}",

    "async function encodeToTarget(canvas, mime, targetBytes, prefer, onProgress) {",
    "  const tryTypes = [mime, 'image/webp', 'image/jpeg', 'image/png'];",
    "  let qMin = 0.45, qMax = 0.92;",
    "  if (prefer === 'ecom') { qMin = 0.6; qMax = 0.95; }",
    "  if (prefer === 'tiny') { qMin = 0.25; qMax = 0.85; }",
    "  if (onProgress) onProgress(60);",
    "  let chosenType = null;",
    "  let best = null;",
    "  for (const t of tryTypes) {",
    "    const r = await searchQuality(canvas, t, targetBytes, qMin, qMax, onProgress);",
    "    if (r && r.blob) {",
    "      chosenType = t;",
    "      best = r;",
    "      if (r.blob.size <= targetBytes) break;",
    "    }",
    "  }",
    "  if (best && best.blob.size > targetBytes) {",
    "    if (onProgress) onProgress(88);",
    "    const width = canvas.width, height = canvas.height;",
    "    const scale = Math.sqrt(targetBytes / best.blob.size);",
    "    const factor = Math.min(0.95, Math.max(0.6, scale));",
    "    const newW = Math.max(1, Math.floor(width * factor));",
    "    const newH = Math.max(1, Math.floor(height * factor));",
    "    const c2 = new OffscreenCanvas(newW, newH);",
    "    const ctx2 = c2.getContext('2d', { alpha: true, desynchronized: true });",
    "    ctx2.drawImage(canvas, 0, 0, newW, newH);",
    "    const blob2 = await safeConvertToBlob(c2, chosenType || mime, clamp((best.q != null) ? best.q : 0.75, 0.2, 0.92));",
    "    if (blob2) best = { blob: blob2, q: (best.q != null) ? best.q : 0.75 };",
    "  }",
    "  if (onProgress) onProgress(95);",
    "  const out = (best && best.blob) ? best.blob : await safeConvertToBlob(canvas, 'image/jpeg', 0.82);",
    "  if (onProgress) onProgress(100);",
    "  return { blob: out, size: out.size, type: out.type };",
    "}",

    "async function searchQuality(canvas, type, targetBytes, qMin, qMax, onProgress) {",
    "  if (type === 'image/png') {",
    "    const b = await safeConvertToBlob(canvas, type, 0.92);",
    "    return { blob: b, q: 1 };",
    "  }",
    "  let lo = qMin, hi = qMax;",
    "  let best = null;",
    "  for (let i = 0; i < 7; i++) {",
    "    const q = (lo + hi) / 2;",
    "    const b = await safeConvertToBlob(canvas, type, q);",
    "    if (!b) return null;",
    "    if (onProgress) onProgress(60 + Math.round((i + 1) * 3.5));",
    "    if (b.size <= targetBytes) { best = { blob: b, q: q }; lo = q; }",
    "    else { hi = q; }",
    "  }",
    "  if (!best) {",
    "    const b = await safeConvertToBlob(canvas, type, qMin);",
    "    best = { blob: b, q: qMin };",
    "  }",
    "  return best;",
    "}",

    "async function safeConvertToBlob(canvas, type, quality) {",
    "  try {",
    "    return await canvas.convertToBlob({ type: type, quality: quality });",
    "  } catch (e) {",
    "    try {",
    "      return await canvas.convertToBlob({ type: 'image/jpeg', quality: clamp(quality, 0.2, 0.92) });",
    "    } catch (e2) {",
    "      return null;",
    "    }",
    "  }",
    "}",

    "function clamp(n, a, b) {",
    "  n = Number(n);",
    "  if (!Number.isFinite(n)) return a;",
    "  return Math.max(a, Math.min(b, n));",
    "}"
  ];

  const workerCode = workerLines.join('\n');
  const blob = new Blob([workerCode], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  state.worker = new Worker(url);
  URL.revokeObjectURL(url);

  state.worker.onmessage = (ev) => {
    const msg = ev.data;
    if (!msg || !msg.type) return;

    if (msg.type === 'PROGRESS') {
      const id = msg.id, progress = msg.progress;
      const bar = document.querySelector('[data-bar="' + id + '"]');
      if (bar) bar.style.width = String(Math.max(0, Math.min(100, progress))) + '%';
      const meta = document.querySelector('[data-meta="' + id + '"]');
      if (meta) meta.textContent = STR[state.lang].compressing;
      return;
    }

    if (msg.type === 'DONE') {
      const id = msg.id;
      const it = state.files.find(x => x.id === id);
      if (!it) return;

      if (it.result && it.result.url) URL.revokeObjectURL(it.result.url);

      const outType = msg.outType;
      const outSize = msg.outSize;
      const outBlob = msg.outBlob;

      const blob2 = new Blob([outBlob], { type: outType });
      const url2 = URL.createObjectURL(blob2);

      it.result = { blob: blob2, url: url2, type: outType, size: outSize, width: msg.width, height: msg.height };
      updateItemUI(it);
      updateButtons();
      return;
    }

    if (msg.type === 'ERROR') {
      const id = msg.id;
      const meta = document.querySelector('[data-meta="' + id + '"]');
      if (meta) meta.textContent = 'âŒ ' + String(msg.error || 'Error');
      const bar = document.querySelector('[data-bar="' + id + '"]');
      if (bar) bar.style.width = '0%';
      state.busy = false;
      $('start').disabled = state.files.length === 0;
      return;
    }

    if (msg.type === 'ALL_DONE') {
      state.busy = false;
      $('start').disabled = state.files.length === 0;
      updateButtons();
      return;
    }
  };
}

/** ---------- Inline Worker End ---------- */

function updateButtons(){
  const hasAnyResult = state.files.some(f => f.result && f.result.blob);
  $('zipAll').disabled = !hasAnyResult;
}

function updateItemUI(it){
  const t = STR[state.lang];
  const orig = fmtBytes(it.size);
  const out = fmtBytes(it.result.size);

  const meta = document.querySelector(`[data-meta="${it.id}"]`);
  if (meta) meta.textContent = t.done(orig, out, sceneLabel());

  const img2 = document.querySelector(`[data-img2="${it.id}"]`);
  if (img2) img2.src = it.result.url;

  const bar = document.querySelector(`[data-bar="${it.id}"]`);
  if (bar) bar.style.width = '100%';

  const dl = document.querySelector(`[data-dl="${it.id}"]`);
  if (dl) dl.disabled = false;
}

function renderList(){
  const list = $('list');
  list.innerHTML = '';
  $('empty').style.display = state.files.length ? 'none' : 'block';

  state.files.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="meta">${escapeHtml(it.type)} Â· ${fmtBytes(it.size)}</div>
        </div>
        <div class="row">
          <button class="btn secondary" data-remove="${it.id}">${STR[state.lang].remove}</button>
          <button class="btn" data-dl="${it.id}" disabled>${STR[state.lang].download}</button>
          <button class="btn secondary" data-retry="${it.id}">${STR[state.lang].retry}</button>
        </div>
      </div>
      <div class="prog"><div class="bar" data-bar="${it.id}"></div></div>
      <div class="hint" style="margin-top:8px" data-meta="${it.id}"></div>
      <div class="preview">
        <div class="pv">
          <div class="pvHead"><span>Original</span><span>${fmtBytes(it.size)}</span></div>
          <img data-img1="${it.id}" src="${it.urlOriginal}" alt="original"/>
        </div>
        <div class="pv">
          <div class="pvHead"><span>Compressed</span><span>-</span></div>
          <img data-img2="${it.id}" src="" alt="compressed"/>
        </div>
      </div>
    `;
    list.appendChild(div);

    const meta = div.querySelector(`[data-meta="${it.id}"]`);
    meta.textContent = '';
  });

  list.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.onclick = () => removeFile(btn.dataset.remove);
  });
  list.querySelectorAll('[data-retry]').forEach(btn=>{
    btn.onclick = () => compressOne(btn.dataset.retry);
  });
  list.querySelectorAll('[data-dl]').forEach(btn=>{
    btn.onclick = () => downloadOne(btn.dataset.dl);
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function addFiles(fileList){
  const files = Array.from(fileList || []);
  const accepted = files.filter(f => /image\/(jpeg|png|webp)/.test(f.type));
  const room = Math.max(0, 20 - state.files.length);
  const pick = accepted.slice(0, room);

  pick.forEach(file=>{
    const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));
    const urlOriginal = URL.createObjectURL(file);
    state.files.push({
      id,
      file,
      name: file.name,
      type: file.type,
      size: file.size,
      urlOriginal,
      result: null
    });
  });

  $('stat').textContent = STR[state.lang].fileCount(state.files.length);
  $('start').disabled = state.files.length === 0 || state.busy;
  renderList();
  updateButtons();
}

function clearAll(){
  state.files.forEach(it=>{
    try{ URL.revokeObjectURL(it.urlOriginal); }catch(e){}
    if (it.result && it.result.url) try{ URL.revokeObjectURL(it.result.url); }catch(e){}
  });
  state.files = [];
  $('stat').textContent = STR[state.lang].fileCount(0);
  $('start').disabled = true;
  $('zipAll').disabled = true;
  renderList();
}

function removeFile(id){
  const idx = state.files.findIndex(x => x.id === id);
  if (idx < 0) return;
  const it = state.files[idx];
  try{ URL.revokeObjectURL(it.urlOriginal); }catch(e){}
  if (it.result && it.result.url) try{ URL.revokeObjectURL(it.result.url); }catch(e){}
  state.files.splice(idx, 1);
  $('stat').textContent = STR[state.lang].fileCount(state.files.length);
  $('start').disabled = state.files.length === 0 || state.busy;
  renderList();
  updateButtons();
}

function modeProfile(){
  if (state.mode === 'social') return { targetBytes: 1 * 1024 * 1024, maxEdge: 2400 };
  if (state.mode === 'ecom')   return { targetBytes: 2 * 1024 * 1024, maxEdge: 3000 };
  return { targetBytes: 500 * 1024, maxEdge: 2000 };
}

async function compressAll(){
  if (!state.files.length) return;
  ensureWorker();
  state.busy = true;
  $('start').disabled = true;

  const prof = modeProfile();

  const payload = [];
  for (const it of state.files) {
    const buf = await it.file.arrayBuffer();
    payload.push({
      id: it.id,
      name: it.name,
      type: it.type,
      size: it.size,
      buffer: buf,
    });
  }

  state.worker.postMessage({
    type: 'QUEUE',
    profile: prof,
    prefer: state.mode,
    items: payload
  }, payload.map(x => x.buffer));
}

async function compressOne(id){
  const it = state.files.find(x => x.id === id);
  if (!it) return;
  ensureWorker();

  const prof = modeProfile();
  const buf = await it.file.arrayBuffer();

  state.worker.postMessage({
    type: 'ONE',
    profile: prof,
    prefer: state.mode,
    item: { id: it.id, name: it.name, type: it.type, size: it.size, buffer: buf }
  }, [buf]);
}

function downloadOne(id){
  const it = state.files.find(x => x.id === id);
  if (!it || !it.result || !it.result.blob) return;

  const ext = it.result.type === 'image/webp' ? 'webp' : (it.result.type === 'image/png' ? 'png' : 'jpg');
  const base = it.name.replace(/\.[^.]+$/, '');
  const filename = `${base}_compressed.${ext}`;

  const a = document.createElement('a');
  a.href = it.result.url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function downloadZip(){
  // V1: sequential downloads for stability
  toast(STR[state.lang].toastZip);
  const results = state.files.filter(f => f.result && f.result.blob);
  results.forEach(r => downloadOne(r.id));
}

function bindUI(){
  $('pick').onclick = () => $('file').click();
  $('file').onchange = (e) => addFiles(e.target.files);
  $('clear').onclick = clearAll;

  document.querySelectorAll('.mode').forEach(el=>{
    el.onclick = () => setMode(el.dataset.mode);
  });

  $('start').onclick = compressAll;
  $('zipAll').onclick = downloadZip;

  $('btnCN').onclick = () => {
    $('btnCN').classList.add('active'); $('btnEN').classList.remove('active');
    setLang('cn');
  };
  $('btnEN').onclick = () => {
    $('btnEN').classList.add('active'); $('btnCN').classList.remove('active');
    setLang('en');
  };

  const drop = $('drop');
  const onDrag = (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); };
  const onLeave = (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); };
  drop.addEventListener('dragenter', onDrag);
  drop.addEventListener('dragover', onDrag);
  drop.addEventListener('dragleave', onLeave);
  drop.addEventListener('drop', (e)=>{
    e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
    addFiles(e.dataTransfer.files);
  });
}

bindUI();
setLang('cn');
setMode('social');
</script>
</body>
</html>
