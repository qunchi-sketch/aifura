<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能抠图 (修复版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: sans-serif; background-color: #f0f4f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
        
        /* 强制限制图标大小 (关键修复) */
        .icon-svg { width: 64px !important; height: 64px !important; color: #3b82f6; margin: 0 auto; display: block; }
        
        .upload-box { border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; background: #f9fafb; transition: all 0.3s; }
        .upload-box:hover { border-color: #3b82f6; background: #eff6ff; }
        
        .btn-primary { width: 100%; background: #2563eb; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        
        /* 结果展示区 */
        .result-flex { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; }
        .result-box { flex: 1; min-width: 300px; background: #eee; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        img { max-width: 100%; height: auto; max-height: 400px; border-radius: 6px; }
        
        /* 棋盘格背景 */
        .checkerboard {
            background-color: #fff;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body>

    <div style="width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="window.location.href='/'">
            <div style="background: #2563eb; color: white; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</div>
            <span style="font-weight: bold; font-size: 20px;">Aifura Tools</span>
        </div>
        <a href="/" style="text-decoration: none; color: #2563eb; font-weight: bold;">返回首页</a>
    </div>

    <div class="container">
        <h1 style="text-align: center; margin-bottom: 10px;">AI 智能一键抠图</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">免费、无限、本地运行 (保护隐私)</p>

        <div class="upload-box" id="uploadArea">
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <svg class="icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <p style="margin-top: 15px; font-weight: 500;">点击或拖拽图片到这里</p>
        </div>

        <div id="controlPanel" style="display: none; margin-top: 20px;">
            <p id="fileName" style="text-align: center; color: #555; margin-bottom: 10px;"></p>
            <button id="processBtn" class="btn-primary">开始一键抠图</button>
            <p id="statusText" style="text-align: center; margin-top: 10px; color: #2563eb; min-height: 24px;"></p>
        </div>

        <div id="resultArea" class="result-flex" style="display: none;">
            <div class="result-box">
                <p style="font-weight: bold; margin-bottom: 10px;">原图</p>
                <img id="imgOriginal" src="">
            </div>
            <div class="result-box checkerboard">
                <p style="font-weight: bold; margin-bottom: 10px; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 4px;">去底结果</p>
                <img id="imgResult" src="">
                <a id="downloadBtn" href="#" style="display: inline-block; margin-top: 15px; background: #10b981; color: white; padding: 8px 20px; text-decoration: none; border-radius: 6px;">下载高清图</a>
            </div>
        </div>
    </div>

    <script type="module">
    // 1. 从你刚才保存的本地文件导入核心功能
    import { removeBackground } from './imgly-background-removal.min.js';

    // 2. 把它挂载到 window 上，让你原本的逻辑代码能找到它
    // (因为你的旧代码用的是 imglyRemoveBackground 这个名字，所以我们要对接一下)
    window.imglyRemoveBackground = removeBackground;
    
    console.log("AI 引擎已加载 (ES Module 模式)");
    </script>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const processBtn = document.getElementById('processBtn');
        const statusText = document.getElementById('statusText');
        const imgOriginal = document.getElementById('imgOriginal');
        const imgResult = document.getElementById('imgResult');
        const controlPanel = document.getElementById('controlPanel');
        const resultArea = document.getElementById('resultArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileName = document.getElementById('fileName');

        let selectedFile = null;

        // 点击上传
        uploadArea.addEventListener('click', () => fileInput.click());
        
        // 监听文件选择
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#2563eb'; });
        uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = '#ccc'; });
        uploadArea.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            uploadArea.style.borderColor = '#ccc';
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            selectedFile = file;
            fileName.textContent = `已选: ${file.name}`;
            imgOriginal.src = URL.createObjectURL(file);
            controlPanel.style.display = 'block';
            resultArea.style.display = 'none';
            statusText.textContent = "";
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // 检查 JS 是否加载成功
            if (typeof imglyRemoveBackground === 'undefined') {
                alert("❌ 错误：AI 引擎文件未加载。\n请检查 'imgly-background-removal.min.js' 是否已上传到 GitHub 的 backgroundremover 文件夹中。");
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = "正在处理...";
            statusText.textContent = "正在启动 AI 引擎 (首次可能需要 30秒)...";
            
            try {
                // 核心抠图逻辑
                const blob = await imglyRemoveBackground(selectedFile, {
                    progress: (key, current, total) => {
                        const percent = Math.round((current / total) * 100);
                        if(key.includes('fetch')) {
                             statusText.textContent = `⬇️ 正在下载 AI 模型组件: ${percent}%`;
                        }
                    }
                });
                
                const url = URL.createObjectURL(blob);
                imgResult.src = url;
                downloadBtn.href = url;
                downloadBtn.download = "cut_" + selectedFile.name;
                
                resultArea.style.display = 'flex';
                statusText.textContent = "✨ 处理成功！";
                statusText.style.color = "green";
                
            } catch (error) {
                console.error(error);
                statusText.textContent = "❌ 出错了: " + error.message;
                statusText.style.color = "red";
                alert("处理失败，请按 F12 查看控制台详细报错。\n\n常见原因：\n1. 网络连接不稳定\n2. GitHub 根目录缺少 _headers 文件");
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = "开始一键抠图";
            }
        });
    </script>
</body>
</html>

